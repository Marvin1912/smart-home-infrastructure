services:
  influxdb:
    image: influxdb:2.7.1
    container_name: influxdb
    hostname: influxdb
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: marvin
      DOCKER_INFLUXDB_INIT_PASSWORD: password
      DOCKER_INFLUXDB_INIT_ORG: wildfly_domain
      DOCKER_INFLUXDB_INIT_BUCKET: costs
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: temp-init-token-will-be-replaced
      INFLUXDB_REPORTING_DISABLED: true
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  influxdb-setup:
    image: bash:5.2.21
    container_name: influxdb-setup
    environment:
      INFLUX_URL: http://host.docker.internal:8086
      INFLUX_ORG: wildfly_domain
    volumes:
      - ./setup_influxdb.sh:/scripts/setup_influxdb.sh:ro
    command: >
      sh -c "
        echo 'Installing dependencies...';
        apk add --no-cache curl jq;
        echo 'Waiting for InfluxDB to be ready...';
        while ! curl -f http://influxdb:8086/health; do
          echo 'InfluxDB not ready, waiting...';
          sleep 5;
        done;
        echo 'InfluxDB is ready, running setup script...';
        chmod +x /scripts/setup_influxdb.sh;
        /scripts/setup_influxdb.sh;
        echo 'Setup completed!';
      "
    depends_on:
      influxdb:
        condition: service_healthy
    restart: "no"
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  influxdb_data:
