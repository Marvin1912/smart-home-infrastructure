apiVersion: v1
kind: ConfigMap
metadata:
  name: influxdb-setup-script
  namespace: default
data:
  setup_influxdb.sh: |
    #!/usr/bin/env bash

    # InfluxDB Configuration Setup Script
    # This script recreates the InfluxDB configuration from 192.168.178.29:8086

    set -e

    # Configuration variables
    # shellcheck disable=SC2269
    INFLUX_URL="${INFLUX_URL:-http://localhost:8086}"
    INFLUX_ORG="wildfly_domain"
    INIT_TOKEN="temp-init-token-will-be-replaced"
    INFLUX_TOKEN="${INFLUX_TOKEN:-}"

    # Colors for output
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m' # No Color

    # Function to print colored output
    print_success() {
        echo -e "${GREEN}âœ“ $1${NC}"
    }

    print_error() {
        echo -e "${RED}âœ— $1${NC}"
    }

    print_info() {
        echo -e "${YELLOW}â„¹ $1${NC}"
    }

    # Generate a new API token using the initial admin token
    generate_api_token() {
        print_info "Generating new API token..."

        # Use the init token to create a proper API token with all permissions
        local org_response=$(curl -s -H "Authorization: Token $INIT_TOKEN" \
            "$INFLUX_URL/api/v2/orgs" | \
            jq -r ".orgs[] | select(.name==\"$INFLUX_ORG\") | .id" 2>/dev/null || echo "")

        if [ -z "$org_response" ]; then
            print_error "Organization '$INFLUX_ORG' not found or init token invalid"
            exit 1
        fi

        # Create a new token with read/write permissions for the organization
        local token_response=$(curl -s -X POST \
            -H "Authorization: Token $INIT_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
                \"status\": \"active\",
                \"description\": \"API token for InfluxDB setup\",
                \"orgID\": \"$org_response\",
                \"permissions\": [
                    {
                        \"action\": \"read\",
                        \"resource\": {
                            \"type\": \"orgs\"
                        }
                    },
                    {
                        \"action\": \"write\",
                        \"resource\": {
                            \"type\": \"orgs\"
                        }
                    },
                    {
                        \"action\": \"read\",
                        \"resource\": {
                            \"type\": \"buckets\",
                            \"orgID\": \"$org_response\"
                        }
                    },
                    {
                        \"action\": \"write\",
                        \"resource\": {
                            \"type\": \"buckets\",
                            \"orgID\": \"$org_response\"
                        }
                    },
                    {
                        \"action\": \"read\",
                        \"resource\": {
                            \"type\": \"tasks\",
                            \"orgID\": \"$org_response\"
                        }
                    },
                    {
                        \"action\": \"write\",
                        \"resource\": {
                            \"type\": \"tasks\",
                            \"orgID\": \"$org_response\"
                        }
                    }
                ]
            }" \
            "$INFLUX_URL/api/v2/authorizations")

        INFLUX_TOKEN=$(echo "$token_response" | jq -r '.token')

        if [ -z "$INFLUX_TOKEN" ] || [ "$INFLUX_TOKEN" = "null" ]; then
            print_error "Failed to generate API token"
            echo "Response: $token_response"
            exit 1
        fi

        print_success "New API token generated successfully"
    }

    # Check if InfluxDB is running
    check_influxdb() {
        print_info "Checking InfluxDB connection... $INFLUX_URL"
        local retries=0
        local max_retries=30

        while [ $retries -lt $max_retries ]; do
            if curl -s "$INFLUX_URL/health" > /dev/null; then
                print_success "InfluxDB is accessible at $INFLUX_URL"
                return 0
            fi
            print_info "Waiting for InfluxDB to be ready... ($((retries + 1))/$max_retries)"
            sleep 2
            retries=$((retries + 1))
        done

        print_error "Cannot connect to InfluxDB at $INFLUX_URL after $max_retries attempts"
        exit 1
    }

    # Check if organization exists, create if not
    setup_organization() {
        print_info "Setting up organization '$INFLUX_ORG'..."

        # Check if org exists
        ORG_ID=$(curl -s -H "Authorization: Token $INFLUX_TOKEN" \
            "$INFLUX_URL/api/v2/orgs" | \
            jq -r ".orgs[] | select(.name==\"$INFLUX_ORG\") | .id" 2>/dev/null || echo "")

        if [ -z "$ORG_ID" ]; then
            print_info "Creating organization '$INFLUX_ORG'..."
            ORG_ID=$(curl -s -X POST -H "Authorization: Token $INFLUX_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"name\":\"$INFLUX_ORG\",\"description\":\"\"}" \
                "$INFLUX_URL/api/v2/orgs" | jq -r '.id')
            print_success "Organization '$INFLUX_ORG' created with ID: $ORG_ID"
        else
            print_success "Organization '$INFLUX_ORG' already exists with ID: $ORG_ID"
        fi
    }

    # Create user buckets
    create_buckets() {
        print_info "Creating user buckets..."

        # Bucket: costs
        print_info "Creating bucket 'costs'..."
        COSTS_BUCKET=$(curl -s -X POST -H "Authorization: Token $INFLUX_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
                "orgID": "'"$ORG_ID"'",
                "name": "costs",
                "retentionRules": [
                    {
                        "type": "expire",
                        "everySeconds": 0,
                        "shardGroupDurationSeconds": 604800
                    }
                ]
            }' \
            "$INFLUX_URL/api/v2/buckets" | jq -r '.id')
        print_success "Bucket 'costs' created with ID: $COSTS_BUCKET"

        # Bucket: sensor_data
        print_info "Creating bucket 'sensor_data'..."
        SENSOR_DATA_BUCKET=$(curl -s -X POST -H "Authorization: Token $INFLUX_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
                "orgID": "'"$ORG_ID"'",
                "name": "sensor_data",
                "retentionRules": [
                    {
                        "type": "expire",
                        "everySeconds": 18316800,
                        "shardGroupDurationSeconds": 604800
                    }
                ]
            }' \
            "$INFLUX_URL/api/v2/buckets" | jq -r '.id')
        print_success "Bucket 'sensor_data' created with ID: $SENSOR_DATA_BUCKET"

        # Bucket: sensor_data_30m
        print_info "Creating bucket 'sensor_data_30m'..."
        SENSOR_DATA_30M_BUCKET=$(curl -s -X POST -H "Authorization: Token $INFLUX_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
                "orgID": "'"$ORG_ID"'",
                "name": "sensor_data_30m",
                "retentionRules": [
                    {
                        "type": "expire",
                        "everySeconds": 0,
                        "shardGroupDurationSeconds": 604800
                    }
                ]
            }' \
            "$INFLUX_URL/api/v2/buckets" | jq -r '.id')
        print_success "Bucket 'sensor_data_30m' created with ID: $SENSOR_DATA_30M_BUCKET"

        # Bucket: system_metrics
        print_info "Creating bucket 'system_metrics'..."
        SYSTEM_METRICS_BUCKET=$(curl -s -X POST -H "Authorization: Token $INFLUX_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
                "orgID": "'"$ORG_ID"'",
                "name": "system_metrics",
                "retentionRules": [
                    {
                        "type": "expire",
                        "everySeconds": 0,
                        "shardGroupDurationSeconds": 604800
                    }
                ]
            }' \
            "$INFLUX_URL/api/v2/buckets" | jq -r '.id')
        print_success "Bucket 'system_metrics' created with ID: $SYSTEM_METRICS_BUCKET"
    }

    # Create scheduled tasks
    create_tasks() {
        print_info "Creating scheduled tasks..."

        # Task 1: Downsample to 30m means (Active)
        print_info "Creating task 'Downsample to 30m means' (Active)..."
        TASK1_FLUX='option task = {name: "Downsample to 30m means", every: 7d}

    from(bucket: "sensor_data")
        |> range(start: -7d)
        |> filter(fn: (r) => r._field == "value")
        |> aggregateWindow(every: 30m, fn: mean, createEmpty: false)
        // |> to(bucket: "sensor_data_30m")'

        TASK1_ID=$(curl -s -X POST -H "Authorization: Token $INFLUX_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
                "orgID": "'"$ORG_ID"'",
                "org": "'"$INFLUX_ORG"'",
                "name": "Downsample to 30m means",
                "status": "active",
                "flux": '"'$(echo "$TASK1_FLUX" | jq -Rs .)'"',
                "every": "7d"
            }' \
            "$INFLUX_URL/api/v2/tasks" | jq -r '.id')
        print_success "Task 'Downsample to 30m means' created with ID: $TASK1_ID"

        # Task 2: Downsample All (Inactive)
        print_info "Creating task 'Downsample All' (Inactive)..."
        TASK2_FLUX='option task = {name: "Downsample All", every: 7d}

    from(bucket: "sensor_data")
        |> range(start: -30d)
        |> filter(fn: (r) => r._field == "value")
        |> aggregateWindow(every: 30m, fn: mean, createEmpty: false)
        |> to(bucket: "sensor_data_30m")'

        TASK2_ID=$(curl -s -X POST -H "Authorization: Token $INFLUX_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
                "orgID": "'"$ORG_ID"'",
                "org": "'"$INFLUX_ORG"'",
                "name": "Downsample All",
                "status": "inactive",
                "flux": '"'$(echo "$TASK2_FLUX" | jq -Rs .)'"',
                "every": "7d"
            }' \
            "$INFLUX_URL/api/v2/tasks" | jq -r '.id')
        print_success "Task 'Downsample All' created with ID: $TASK2_ID"
    }

    # Verify configuration
    verify_setup() {
        print_info "Verifying configuration..."

        echo ""
        print_info "Created buckets:"
        curl -s -H "Authorization: Token $INFLUX_TOKEN" \
            "$INFLUX_URL/api/v2/buckets?org=$INFLUX_ORG" | \
            jq -r '.buckets[] | "  - \(.name) (ID: \(.id), Retention: \(.retentionRules[0].everySeconds // "infinite") seconds)"'

        echo ""
        print_info "Created tasks:"
        curl -s -H "Authorization: Token $INFLUX_TOKEN" \
            "$INFLUX_URL/api/v2/tasks?org=$INFLUX_ORG" | \
            jq -r '.tasks[] | "  - \(.name) (ID: \(.id), Status: \(.status), Every: \(.every))"'
    }

    # Main execution
    main() {
        echo "ðŸš€ InfluxDB Configuration Setup Script"
        echo "====================================="
        echo "Target: $INFLUX_URL"
        echo "Organization: $INFLUX_ORG"
        echo ""

        check_influxdb
        generate_api_token
        setup_organization
        create_buckets
        create_tasks
        verify_setup

        echo ""
        print_success "InfluxDB configuration setup completed successfully!"
        echo ""
        echo "Configuration Summary:"
        echo "  - Organization: $INFLUX_ORG (ID: $ORG_ID)"
        echo "  - User Buckets: 4 (costs, sensor_data, sensor_data_30m, system_metrics)"
        echo "  - Tasks: 2 (1 active, 1 inactive)"
        echo "  - Generated API Token: ${INFLUX_TOKEN:0:20}..."
        echo ""
        echo "Note: The 'Downsample to 30m means' task has its to() bucket line commented out,"
        echo "exactly as in the original configuration."
    }

    # Run main function
    main "$@"

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: applications
  labels:
    app: applications
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: applications
  template:
    metadata:
      labels:
        app: applications
    spec:
      containers:
        - name: applications
          image: localhost:5000/applications:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
          env:
            - name: JAVA_OPTS
              value: "-Xms512m -Xmx1024m"
            - name: ADAPTER_PORT
              value: "9001"
            - name: DATA_SOURCE
              value: "jdbc:postgresql://192.168.178.29:5432/costs"
            - name: DATA_SOURCE_USERNAME
              value: "marvin"
            - name: DATA_SOURCE_PASSWORD
              value: "password"
            - name: MAIL_USERNAME
              value: ""
            - name: MAIL_PASSWORD
              value: ""
            - name: CAMT_DIRECTORY_IN
              value: "./app/camt"
            - name: CAMT_DIRECTORY_DONE
              value: "./app/camt/done"
            - name: IMPORTER_IN_COSTS
              value: "./app/import/costs"
            - name: IMPORTER_IN_SENSORDATA
              value: "./app/import/sensordata"
            - name: IMPORTER_DONE
              value: "./app/import/done"
            - name: EXPORTER_FOLDER
              value: "./app/export"
            - name: UPLOADER_CREDENTIALS_PATH
              value: "./app/google/credentials.json"
            - name: UPLOADER_COST_EXPORT_FOLDER
              value: "./app/export"
            - name: INFLUX_URL
              value: "http://192.168.178.29:8086"
            - name: INFLUX_TOKEN
              value: "rmz5aaaKYSpgvXSO3C1UFZmXjvtpwI81b7hcMaMJJqOTjvgI82iNAbSsF7fpGIy2fduNDKACQ759cyaiECrulg=="
            - name: INFLUX_ORG
              value: "wildfly_domain"
            - name: INFLUXDB_EXPORT_ENABLED
              value: "false"
            - name: CONSUL_URL
              value: "http://192.168.178.29:8500"
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "1024Mi"
              cpu: "500m"
          volumeMounts:
          - name: data
            mountPath: /data
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: local-mount-pvc

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: influxdb
  labels:
    app: influxdb
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: influxdb
  template:
    metadata:
      labels:
        app: influxdb
    spec:
      initContainers:
        - name: influxdb-setup
          image: appropriate/curl:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              apk add --no-cache jq
              chmod +x /scripts/setup_influxdb.sh
              /scripts/setup_influxdb.sh
          env:
            - name: INFLUX_URL
              value: "http://influxdb:8086"
            - name: INFLUX_ORG
              value: "wildfly_domain"
            - name: INIT_TOKEN
              value: "rmz5aaaKYSpgvXSO3C1UFZmXjvtpwI81b7hcMaMJJqOTjvgI82iNAbSsF7fpGIy2fduNDKACQ759cyaiECrulg=="
          volumeMounts:
            - name: influxdb-setup-script
              mountPath: /scripts/setup_influxdb.sh
              subPath: setup_influxdb.sh
          resources:
            requests:
              memory: "64Mi"
              cpu: "100m"
            limits:
              memory: "128Mi"
              cpu: "200m"
      containers:
        - name: influxdb
          image: influxdb:2.7.1
          imagePullPolicy: Always
          ports:
            - containerPort: 8086
              name: http
          env:
            - name: DOCKER_INFLUXDB_INIT_MODE
              value: "setup"
            - name: DOCKER_INFLUXDB_INIT_USERNAME
              value: "marvin"
            - name: DOCKER_INFLUXDB_INIT_PASSWORD
              value: "password"
            - name: DOCKER_INFLUXDB_INIT_ORG
              value: "wildfly_domain"
            - name: DOCKER_INFLUXDB_INIT_BUCKET
              value: "costs"
            - name: DOCKER_INFLUXDB_INIT_ADMIN_TOKEN
              value: "rmz5aaaKYSpgvXSO3C1UFZmXjvtpwI81b7hcMaMJJqOTjvgI82iNAbSsF7fpGIy2fduNDKACQ759cyaiECrulg=="
            - name: INFLUXDB_REPORTING_DISABLED
              value: "true"
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          volumeMounts:
            - name: influxdb-data
              mountPath: /var/lib/influxdb
      volumes:
        - name: influxdb-data
          persistentVolumeClaim:
            claimName: influxdb-pvc
        - name: influxdb-setup-script
          configMap:
            name: influxdb-setup-script
